generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum UserRole {
  admin
  user
}

enum UserStatus {
  pending
  active
}

enum EmploymentStatus {
  activo
  baja
  suspendido
}

enum SalaryType {
  diario
  mensual
}

enum TaskStatus {
  pending
  completed
}

enum PayrollEventType {
  alta
  baja
  incapacidad
  vacaciones
}

//////////////////////////////////////////////////////
// USERS (id sincronizado con auth.users.id en Supabase)
//////////////////////////////////////////////////////

model User {
  id       String    @id @db.Uuid
  email    String    @unique @db.VarChar(255)
  fullName String    @map("full_name") @db.VarChar(150)
  role     UserRole  @default(user)
  status   UserStatus @default(pending)
  isActive Boolean   @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  createdTasks    Task[]   @relation("TaskCreatedBy")
  assignedTasks   Task[]   @relation("TaskAssignedTo")
  comments        Comment[]
  monthlyActivities MonthlyActivity[]
  createdEmployees Employee[] @relation("EmployeeCreatedBy")
  payrollEvents   PayrollEvent[] @relation("PayrollEventCreatedBy")
  dashboardMessages DashboardMessage[]

  @@map("users")
}

//////////////////////////////////////////////////////
// CLIENTS
//////////////////////////////////////////////////////

model Client {
  id             String   @id @default(uuid()) @db.Uuid
  name           String   @db.VarChar(200)
  rfc            String   @db.VarChar(20)
  clavePatronal  String?  @map("clave_patronal") @db.VarChar(50)
  email          String?  @db.VarChar(255)
  phone          String?  @db.VarChar(20)
  portalToken    String   @unique @map("portal_token") @db.VarChar(255)
  isActive       Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  employees     Employee[]
  payrollEvents PayrollEvent[]
  receipts      Receipt[]

  @@index([rfc])
  @@map("clients")
}

//////////////////////////////////////////////////////
// EMPLOYEES
//////////////////////////////////////////////////////

model Employee {
  id             String   @id @default(uuid()) @db.Uuid
  clientId       String   @map("client_id") @db.Uuid
  client         Client   @relation(fields: [clientId], references: [id])
  employeeNumber String?  @map("employee_number") @db.VarChar(50)

  firstName      String  @map("first_name") @db.VarChar(100)
  lastName       String  @map("last_name") @db.VarChar(100)
  motherLastName String? @map("mother_last_name") @db.VarChar(100)

  rfc  String @db.VarChar(20)
  curp String @db.VarChar(20)
  nss  String @db.VarChar(20)

  street          String? @db.VarChar(150)
  exteriorNumber  String? @map("exterior_number") @db.VarChar(20)
  interiorNumber  String? @map("interior_number") @db.VarChar(20)
  neighborhood    String? @db.VarChar(150)
  municipality    String? @db.VarChar(150)
  state           String? @db.VarChar(150)
  postalCode      String  @map("postal_code") @db.VarChar(10)
  country         String  @default("MÃ©xico") @db.VarChar(100)

  hireDate             DateTime    @map("hire_date")
  terminationDate      DateTime?   @map("termination_date")
  employmentStatus     EmploymentStatus @map("employment_status")
  contractType         String?     @map("contract_type") @db.VarChar(50)
  position             String?     @db.VarChar(150)
  department           String?     @db.VarChar(150)
  salaryType           SalaryType? @map("salary_type")
  dailySalary          Decimal?    @map("daily_salary") @db.Decimal(12, 2)
  integratedDailySalary Decimal?   @map("integrated_daily_salary") @db.Decimal(12, 2)

  bankName    String? @map("bank_name") @db.VarChar(150)
  bankAccount String? @map("bank_account") @db.VarChar(50)
  clabe       String? @db.VarChar(18)

  isActive Boolean @default(true) @map("is_active")

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  createdById String?  @map("created_by") @db.Uuid
  createdBy   User?    @relation("EmployeeCreatedBy", fields: [createdById], references: [id])

  payrollEvents PayrollEvent[]

  @@index([clientId])
  @@index([clientId, rfc])
  @@index([clientId, curp])
  @@map("employees")
}

//////////////////////////////////////////////////////
// PAYROLL EVENTS
//////////////////////////////////////////////////////

model PayrollEvent {
  id         String   @id @default(uuid()) @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid
  clientId   String   @map("client_id") @db.Uuid

  employee Employee @relation(fields: [employeeId], references: [id])
  client   Client   @relation(fields: [clientId], references: [id])

  eventType PayrollEventType @map("event_type")
  startDate DateTime         @map("start_date")
  endDate   DateTime?        @map("end_date")
  notes     String?

  createdAt  DateTime @default(now()) @map("created_at")
  createdById String? @map("created_by") @db.Uuid
  createdBy   User?   @relation("PayrollEventCreatedBy", fields: [createdById], references: [id])

  @@index([employeeId])
  @@index([clientId])
  @@map("payroll_events")
}

//////////////////////////////////////////////////////
// DASHBOARD MESSAGES (chat fijable)
//////////////////////////////////////////////////////

model DashboardMessage {
  id       String   @id @default(uuid()) @db.Uuid
  userId   String   @map("user_id") @db.Uuid
  user     User     @relation(fields: [userId], references: [id])
  content  String   @db.VarChar(2000)
  isPinned Boolean  @default(false) @map("is_pinned")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([isPinned])
  @@map("dashboard_messages")
}

//////////////////////////////////////////////////////
// TASKS
//////////////////////////////////////////////////////

model Task {
  id          String   @id @default(uuid()) @db.Uuid
  title       String   @db.VarChar(200)
  description String?

  createdById  String @map("created_by") @db.Uuid
  assignedToId String @map("assigned_to") @db.Uuid

  createdBy  User @relation("TaskCreatedBy", fields: [createdById], references: [id])
  assignedTo User @relation("TaskAssignedTo", fields: [assignedToId], references: [id])

  dueDate   DateTime?  @map("due_date")
  status    TaskStatus
  isUrgent  Boolean    @default(false) @map("is_urgent")
  isActive  Boolean    @default(true) @map("is_active")

  monthlyActivityId String? @map("monthly_activity_id") @db.Uuid
  monthlyActivity   MonthlyActivity? @relation(fields: [monthlyActivityId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  subtasks Subtask[]
  comments Comment[]

  @@index([assignedToId])
  @@index([dueDate])
  @@index([isActive])
  @@map("tasks")
}

//////////////////////////////////////////////////////
// SUBTASKS
//////////////////////////////////////////////////////

model Subtask {
  id        String   @id @default(uuid()) @db.Uuid
  taskId    String   @map("task_id") @db.Uuid
  task      Task     @relation(fields: [taskId], references: [id])

  title       String   @db.VarChar(200)
  isCompleted Boolean  @default(false) @map("is_completed")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([taskId])
  @@map("subtasks")
}

//////////////////////////////////////////////////////
// COMMENTS
//////////////////////////////////////////////////////

model Comment {
  id      String   @id @default(uuid()) @db.Uuid
  taskId  String   @map("task_id") @db.Uuid
  userId  String   @map("user_id") @db.Uuid

  task Task @relation(fields: [taskId], references: [id])
  user User @relation(fields: [userId], references: [id])

  content   String
  createdAt DateTime @default(now()) @map("created_at")

  @@map("comments")
}

//////////////////////////////////////////////////////
// MONTHLY ACTIVITIES
//////////////////////////////////////////////////////

model MonthlyActivity {
  id         String  @id @default(uuid()) @db.Uuid
  userId     String  @map("user_id") @db.Uuid
  user       User    @relation(fields: [userId], references: [id])

  title      String  @db.VarChar(200)
  dayOfMonth Int     @map("day_of_month")
  isActive   Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")

  tasks Task[]

  @@map("monthly_activities")
}

//////////////////////////////////////////////////////
// RECEIPTS
//////////////////////////////////////////////////////

model Receipt {
  id         String   @id @default(uuid()) @db.Uuid
  clientId   String   @map("client_id") @db.Uuid
  client     Client   @relation(fields: [clientId], references: [id])

  folio       Int      @unique
  issueDate   DateTime @map("issue_date")
  totalAmount Decimal  @map("total_amount") @db.Decimal(12, 2)

  notes    String?
  isActive Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  items ReceiptItem[]

  @@index([clientId])
  @@map("receipts")
}

//////////////////////////////////////////////////////
// RECEIPT ITEMS
//////////////////////////////////////////////////////

model ReceiptItem {
  id        String  @id @default(uuid()) @db.Uuid
  receiptId String  @map("receipt_id") @db.Uuid
  conceptId String  @map("concept_id") @db.Uuid

  receipt  Receipt  @relation(fields: [receiptId], references: [id])
  concept  Concept  @relation(fields: [conceptId], references: [id])

  description String?  @db.VarChar(255)
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  subtotal    Decimal  @db.Decimal(12, 2)

  @@index([receiptId])
  @@map("receipt_items")
}

//////////////////////////////////////////////////////
// CONCEPTS
//////////////////////////////////////////////////////

model Concept {
  id       String  @id @default(uuid()) @db.Uuid
  name     String  @unique @db.VarChar(150)
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")

  receiptItems ReceiptItem[]

  @@map("concepts")
}
